Proper multi threading with db - refactor it so each function gets itself a connection and opens it itself